<!DOCTYPE html>
<html lang="en">
<head>
 <title>showgifs</title>
 <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <div id="grid">
    </div>
</body>
<script>
    gridDiv = document.getElementById("grid")

    ok = "/Users/pilewicz/Downloads/fixed_broken_bis.gif"
    broken = "/Users/pilewicz/Downloads/ok.gif"
    images = [ok, broken]

    // production
    setCellUrl = "https://br0vxymk66.execute-api.eu-central-1.amazonaws.com/v1/set_cell"
    getGridUrl = "https://br0vxymk66.execute-api.eu-central-1.amazonaws.com/v1/get_grid"

    function buildGridFromJson(j) {
        nb_rows = j['nb_rows']
        nb_cols = j['nb_cols']
        gridDiv.style["grid-template-columns"] = `repeat(${nb_cols}, ${100/nb_cols}%)`
        gridDiv.style["grid-template-rows"] = `repeat(${nb_rows}, ${100/nb_rows}%)`
        for (x = 0; x < nb_cols; x++) {
            for (y = 0; y < nb_rows; y++) {
                img = document.createElement("img")
                key = `x:${x},y:${y}`
                img.id = key
                img.clausiusX = x
                img.clausiusY = y
                currentState = j[key]
                img.currentState = currentState
                img.onclick = changeState

                img.border = 0
                img.style = `grid-column: ${x + 1}; grid-row: ${y + 1};`
                img.src = images[currentState]

                img.recentlyClicked = false

                grid.appendChild(img)
            }
        }
    }
    function updateGridFromJson(j) {
        nb_rows = j['nb_rows']
        nb_cols = j['nb_cols']
        for (x = 0; x < nb_cols; x++) {
            for (y = 0; y < nb_rows; y++) {
                key = `x:${x},y:${y}`
                img = document.getElementById(key)

                currentState = j[key]
                if (img.currentState != currentState && !img.recentlyClicked) {
                    img.currentState = currentState
                    img.src = images[currentState]
                }

                img.recentlyClicked = false
            }
        }
    }
    function changeState(event) {
        img = event.target
        x = img.clausiusX
        y = img.clausiusY
        currentState = img.currentState
        otherState = 1 - currentState
        img.src = images[otherState]
        img.currentState = otherState
        img.recentlyClicked = true
        fetch(
            `${setCellUrl}?x=${x}&y=${y}&v=${otherState}`,
            {method: 'POST'})
    }
    r = fetch(getGridUrl)
        .then(response => r = response.json())
        .then(buildGridFromJson)

    function queryAndUpdateGrid() {
        r = fetch(getGridUrl)
            .then(response => r = response.json())
            .then(updateGridFromJson)
    }
    window.setInterval(queryAndUpdateGrid, 10000)

</script>
</html>
