<!DOCTYPE html>
<html lang="en">
<head>
 <title>showgifs</title>
 <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <div id="grid">
    </div>
</body>
<script>
    gridDiv = document.getElementById("grid")

    setCellUrl = "${api_invoke_url}/${set_cell_resource}"
    getGridUrl = "${api_invoke_url}/${get_grid_resource}"

    function buildGridFromJson(j) {
        nb_rows = j['nb_rows']
        nb_cols = j['nb_cols']
        gridDiv.style["grid-template-columns"] = `repeat($${nb_cols}, $${100/nb_cols}%)`
        gridDiv.style["grid-template-rows"] = `repeat($${nb_rows}, $${100/nb_rows}%)`
        for (x = 0; x < nb_cols; x++) {
            for (y = 0; y < nb_rows; y++) {
                picture = document.createElement("picture")
                key = `x:$${x},y:$${y}`
                picture.id = key
                picture.clausiusX = x
                picture.clausiusY = y
                currentState = j[key]
                picture.currentState = currentState
                picture.onclick = changeState

                picture.border = 0
                picture.style = `grid-column: $${x + 1}; grid-row: $${y + 1};`

                ok = document.createElement("source")
                ok.srcset = "ok.gif"
                ok.id = `$${key}_ok`
                broken = document.createElement("source")
                broken.srcset = "broken.gif"
                broken.id = `$${key}_broken`
                img = document.createElement("img")
                img.src = "ok.gif"

                picture.appendChild(ok)
                picture.appendChild(broken)
                picture.appendChild(img)
                grid.appendChild(picture)

                setImg(picture)

                picture.recentlyClicked = false
            }
        }
    }

    function setImg(picture) {
        key = picture.id
        if (picture.currentState == 0) {
            desiredSource = document.getElementById(`$${key}_ok`)
            undesiredSource = document.getElementById(`$${key}_broken`)
        } else {
            desiredSource = document.getElementById(`$${key}_broken`)
            undesiredSource = document.getElementById(`$${key}_ok`)
        }
        desiredSource.media = "(min-width: 1px)"
        undesiredSource.media = "(max-width: 1px)"
    }

    function updateGridFromJson(j) {
        nb_rows = j['nb_rows']
        nb_cols = j['nb_cols']
        for (x = 0; x < nb_cols; x++) {
            for (y = 0; y < nb_rows; y++) {
                key = `x:$${x},y:$${y}`
                picture = document.getElementById(key)

                currentState = j[key]
                if (picture.currentState != currentState && !picture.recentlyClicked) {
                    picture.currentState = currentState
                    setImg(picture)
                }

                picture.recentlyClicked = false
            }
        }
    }
    function changeState(event) {
        picture = event.currentTarget
        x = picture.clausiusX
        y = picture.clausiusY
        currentState = picture.currentState
        otherState = 1 - currentState
        picture.currentState = otherState
        setImg(picture)
        picture.recentlyClicked = true
        fetch(
            `$${setCellUrl}?x=$${x}&y=$${y}&v=$${otherState}`,
            {method: 'POST'})
    }
    r = fetch(getGridUrl)
        .then(response => r = response.json())
        .then(buildGridFromJson)

    function queryAndUpdateGrid() {
        r = fetch(getGridUrl)
            .then(response => r = response.json())
            .then(updateGridFromJson)
    }
    window.setInterval(queryAndUpdateGrid, ${refresh_seconds * 1000})

</script>
</html>
