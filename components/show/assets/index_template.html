<!DOCTYPE html>
<html lang="en">
<head>
 <title>showgifs</title>
 <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <div id="grid">
    </div>
</body>
<script>
    gridDiv = document.getElementById("grid")

    ok = "ok.png"
    broken = "broken.png"
    images = [ok, broken]

    setCellUrl = "${api_invoke_url}/${set_cell_resource}"
    getGridUrl = "${api_invoke_url}/${get_grid_resource}"

    function buildGridFromJson(j) {
        nb_rows = j['nb_rows']
        nb_cols = j['nb_cols']
        gridDiv.style["grid-template-columns"] = `repeat($${nb_cols}, $${100/nb_cols}%)`
        gridDiv.style["grid-template-rows"] = `repeat($${nb_rows}, $${100/nb_rows}%)`
        for (x = 0; x < nb_cols; x++) {
            for (y = 0; y < nb_rows; y++) {
                img = document.createElement("img")
                key = `x:$${x},y:$${y}`
                img.id = key
                img.clausiusX = x
                img.clausiusY = y
                currentState = j[key]
                img.currentState = currentState
                img.onclick = changeState

                img.border = 0
                img.style = `grid-column: $${x + 1}; grid-row: $${y + 1};`
                img.src = images[currentState]

                grid.appendChild(img)
            }
        }
    }
    function updateGridFromJson(j) {
        nb_rows = j['nb_rows']
        nb_cols = j['nb_cols']
        for (x = 0; x < nb_cols; x++) {
            for (y = 0; y < nb_rows; y++) {
                key = `x:$${x},y:$${y}`
                img = document.getElementById(key)

                currentState = j[key]
                if (img.currentState != currentState) {
                    img.currentState = currentState
                    img.src = images[currentState]
                }
            }
        }
    }
    function changeState(event) {
        img = event.target
        x = img.clausiusX
        y = img.clausiusY
        currentState = img.currentState
        otherState = 1 - currentState
        img.src = images[otherState]
        img.currentState = otherState
        // console.log(`https://5zvhlq0i2j.execute-api.eu-central-1.amazonaws.com/v1/set_cell?x=$${x}&y=$${y}&v=$${otherState}`)
        fetch(
            `$${setCellUrl}?x=$${x}&y=$${y}&v=$${otherState}`,
            {method: 'POST'})
    }
    r = fetch(getGridUrl)
        .then(response => r = response.json())
        .then(buildGridFromJson)

    function queryAndUpdateGrid() {
        r = fetch(getGridUrl)
            .then(response => r = response.json())
            .then(updateGridFromJson)
    }
    window.setInterval(queryAndUpdateGrid, ${refresh_seconds * 1000})

</script>
</html>
